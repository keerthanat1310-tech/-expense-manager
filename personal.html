<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Personal Dashboard ‚Äî Expense Manager</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    if (!localStorage.getItem('loggedInUser')) {
      window.location.href = 'login .html';
    }
  </script>

  <style>
    :root {
      --bg: #070708;
      --panel: #0f1112;
      --muted: #9aa4ac;
      --accent: #0b74d1;
      --spend: #e67b88;
      --income: #79c78a;
      --card: #0f1416;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      color: #e7eef6;
      background: linear-gradient(180deg, #060607, #0b0c0d);
    }

    .wrap {
      max-width: 1100px;
      margin: 28px auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 20px;
      align-items: start;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px
    }

    .greet {
      display: flex;
      flex-direction: column
    }

    .greet .salute {
      color: var(--muted);
      font-size: 14px
    }

    .greet .name {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: 1px
    }

    .icons {
      display: flex;
      gap: 10px;
      align-items: center
    }

    .round {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.01));
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(255, 255, 255, 0.03)
    }

    .controls {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      align-items: center
    }

    select.month {
      background: transparent;
      color: inherit;
      border: 0;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 15px
    }

    .searchbtn {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.04);
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      color: var(--muted)
    }

    .pills {
      margin-top: 18px;
      display: flex;
      gap: 14px;
      flex-wrap: wrap
    }

    .pill {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 18px;
      border-radius: 999px;
      min-width: 210px
    }

    .pill .dot {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700
    }

    .pill .meta {
      display: flex;
      flex-direction: column
    }

    .pill .title {
      font-size: 13px;
      opacity: 0.95
    }

    .pill .val {
      font-size: 20px;
      font-weight: 700
    }

    .pill.spend {
      background: linear-gradient(180deg, rgba(230, 123, 136, 0.10), rgba(230, 123, 136, 0.06));
      border: 1px solid rgba(230, 123, 136, 0.08)
    }

    .pill.spend .dot {
      background: var(--spend);
      color: #fff
    }

    .pill.income {
      background: linear-gradient(180deg, rgba(121, 199, 138, 0.08), rgba(121, 199, 138, 0.04));
      border: 1px solid rgba(121, 199, 138, 0.06)
    }

    .pill.income .dot {
      background: var(--income);
      color: #06220a
    }

    .card {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
      padding: 18px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.03);
      margin-top: 20px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .recent {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px
    }

    .tx {
      display: flex;
      gap: 12px;
      align-items: center;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), rgba(255, 255, 255, 0.007));
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.015)
    }

    .tx .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.02);
      color: var(--muted)
    }

    .tx .meta {
      flex: 1;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center
    }

    .tx .left {
      display: flex;
      flex-direction: column;
      gap: 4px
    }

    .tx .desc {
      font-weight: 700
    }

    .tx .sub {
      color: var(--muted);
      font-size: 13px
    }

    .tx .right {
      text-align: right
    }

    .tx .amt {
      font-weight: 800
    }

    .tx .date {
      color: var(--muted);
      font-size: 13px
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 14px
    }

    .onboard {
      background: linear-gradient(180deg, #071a2a, #072131);
      padding: 16px;
      border-radius: 10px;
      border: 1px solid rgba(13, 54, 83, 0.35)
    }

    .onboard h4 {
      margin: 0 0 8px 0
    }

    .onboard ul {
      padding-left: 18px;
      margin: 0;
      color: #cfeaff
    }

    .bottom-nav {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.8));
      padding: 10px 20px;
      display: flex;
      justify-content: center;
      border-top: 1px solid rgba(255, 255, 255, 0.02);
      z-index: 60
    }

    .nav-inner {
      max-width: 1100px;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center
    }

    .nav-left,
    .nav-right {
      display: flex;
      gap: 26px;
      align-items: center;
      color: var(--muted)
    }

    .center-add {
      transform: translateY(-28px)
    }

    .add-circle {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #111;
      font-size: 34px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
      cursor: pointer
    }

    .modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      align-items: center;
      justify-content: center;
      z-index: 120
    }

    .modal {
      width: 520px;
      background: linear-gradient(180deg, #0b1114, #061015);
      border-radius: 12px;
      padding: 18px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      box-shadow: 0 30px 70px rgba(0, 0, 0, 0.7)
    }

    .modal h3 {
      margin: 0 0 8px 0
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center
    }

    .type-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 10px
    }

    .type-toggle label {
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.02);
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.02)
    }

    .modal input[type="number"],
    .modal input[type="text"],
    .modal input[type="date"] {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      background: transparent;
      color: #e7eef6;
      margin-bottom: 8px
    }

    .modal .note {
      height: 64px;
      resize: none;
      padding: 10px
    }

    .modal .actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px
    }

    .btn {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer
    }

    .btn.cancel {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.04);
      color: var(--muted)
    }

    .btn.save {
      background: var(--accent);
      color: #fff
    }

    .cat-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin: 8px 0 12px
    }

    .cat-item {
      background: rgba(255, 255, 255, 0.02);
      padding: 10px;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      border: 1px solid transparent
    }

    .cat-item.selected {
      border-color: rgba(11, 116, 209, 0.6);
      box-shadow: 0 8px 20px rgba(11, 116, 209, 0.06);
      transform: translateY(-2px)
    }

    .cat-emoji {
      font-size: 20px
    }

    .cat-name {
      font-size: 13px;
      color: var(--muted);
      margin-top: 6px
    }

    .muted {
      color: var(--muted)
    }

    #pieChart {
      max-width: 250px;
      max-height: 250px;
      margin: 20px auto;
      display: block;
    }

    @media (max-width:1000px) {
      .wrap {
        grid-template-columns: 1fr;
        padding-bottom: 140px
      }

      .modal {
        width: 92%
      }
    }
  </style>
</head>

<body>

  <div class="wrap">

    <!-- MAIN -->
    <div>
      <div class="topbar">
        <div class="greet">
          <div class="salute" id="greeting">Good Day</div>
          <div class="name" id="userName">User</div>
          <div class="controls">
            <select id="monthSel" class="month">
              <option value="this">This month</option>
              <option value="last">Last month</option>
              <option value="year">This year</option>
            </select>
            <button class="searchbtn" onclick="alert('search')">üîç</button>
          </div>
        </div>

        <div class="icons">
          <div class="round" title="Premium">üíé</div>
          <div class="round" title="Profile">üë§</div>
        </div>
      </div>

      <div class="pills" style="margin-top:18px">
        <div class="pill spend">
          <div class="dot">‚Üë</div>
          <div class="meta">
            <div class="title">Spending</div>
            <div class="val">‚Çπ <span id="spendVal">0</span></div>
          </div>
        </div>

        <div class="pill income">
          <div class="dot">‚Üì</div>
          <div class="meta">
            <div class="title">Income</div>
            <div class="val">‚Çπ <span id="incomeVal">0</span></div>
          </div>
        </div>
      </div>

      <canvas id="pieChart"></canvas>

      <div class="card" style="margin-top:14px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Recent transactions</div>
          <a href="#" class="muted" onclick="viewAll(event)">See all</a>
        </div>

        <div id="recentList" class="recent" aria-live="polite">
          <!-- filled by JS -->
        </div>
      </div>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="onboard">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h4 style="margin:0;color:#cfeaff">Take Your First Steps</h4>
          <button onclick="dismissOnboard()"
            style="background:transparent;border:none;color:#8fbde6;cursor:pointer">‚úï</button>
        </div>
        <ul style="margin-top:10px">
          <li>Set your budget for this month</li>
          <li>Set up recurring transactions</li>
        </ul>
        <div style="margin-top:12px;color:#8fbde6;font-weight:700">‚Ä∫ COMPLETED (5)</div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="muted">Account</div>
            <div style="font-weight:700;margin-top:6px">Primary Wallet</div>
          </div>
          <div style="text-align:right">
            <div class="muted">Balance</div>
            <div style="font-weight:700;margin-top:6px">‚Çπ <span id="walletBal">10000</span></div>
          </div>
        </div>
      </div>
    </div>

  </div> <!-- wrap -->

  <div class="bottom-nav" role="navigation">
    <div class="nav-inner">
      <div class="nav-left" onclick="window.location.href='home.html'" style="cursor:pointer">üè† <span
          class="muted">Home</span></div>
      <div class="center-add">
        <div class="add-circle" id="openModal">+</div>
      </div>
      <div class="nav-right"><span class="muted">Accounts</span> ‚ãØ</div>
    </div>
  </div>

  <div id="backdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Add Transaction</h3>

      <div class="type-toggle" aria-hidden="false">
        <label><input type="radio" name="ttype" value="expense" checked> Expense</label>
        <label><input type="radio" name="ttype" value="income"> Income</label>
      </div>

      <input id="amountInput" type="number" placeholder="Amount (‚Çπ)" min="0" step="0.01" />

      <div style="font-size:13px;color:var(--muted);margin-bottom:6px">Choose category</div>
      <div id="catGrid" class="cat-grid"></div>

      <input id="dateInput" type="date" />
      <input id="noteInput" type="text" placeholder="Note (optional)" />

      <div class="actions" style="margin-top:10px">
        <button class="btn cancel" onclick="closeModal()">Cancel</button>
        <button class="btn save" id="saveBtn" onclick="saveTx()">Save</button>
      </div>
    </div>
  </div>

  <script>
    const categories = [
      { id: 'food', name: 'Food', emoji: 'üçî' },
      { id: 'shopping', name: 'Shopping', emoji: 'üõçÔ∏è' },
      { id: 'recharge', name: 'Recharge', emoji: 'üì±' },
      { id: 'fuel', name: 'Fuel', emoji: '‚õΩ' },
      { id: 'transport', name: 'Transport', emoji: 'üöï' },
      { id: 'salary', name: 'Salary', emoji: 'üíº' },
      { id: 'gift', name: 'Gift', emoji: 'üéÅ' },
      { id: 'entertain', name: 'Entertainment', emoji: 'üé¨' }
    ];

    const spendEl = document.getElementById('spendVal');
    const incomeEl = document.getElementById('incomeVal');
    const recentList = document.getElementById('recentList');
    const walletEl = document.getElementById('walletBal');
    const backdrop = document.getElementById('backdrop');
    const catGrid = document.getElementById('catGrid');
    let selectedCategory = categories[0].id;
    let pieChart = null;

    let transactions = [];
    const username = localStorage.getItem('loggedInUser');
    const userEmail = localStorage.getItem('userEmail');

    if (!userEmail) {
      window.location.href = 'login .html';
    }

    document.getElementById('userName').textContent = username;

    const hour = new Date().getHours();
    let greet = 'Good Day';
    if (hour < 12) greet = 'Good Morning';
    else if (hour < 17) greet = 'Good Afternoon';
    else greet = 'Good Evening';
    document.getElementById('greeting').textContent = greet;

    function buildCategoryGrid() {
      catGrid.innerHTML = '';
      categories.forEach(cat => {
        const div = document.createElement('div');
        div.className = 'cat-item' + (cat.id === selectedCategory ? ' selected' : '');
        div.dataset.id = cat.id;
        div.innerHTML = `<div class="cat-emoji">${cat.emoji}</div><div class="cat-name">${cat.name}</div>`;
        div.addEventListener('click', () => { selectedCategory = cat.id; document.querySelectorAll('.cat-item').forEach(n => n.classList.remove('selected')); div.classList.add('selected'); });
        catGrid.appendChild(div);
      });
    }

    function calculateTotals() {
      let spend = 0;
      let income = 0;
      transactions.forEach(t => {
        if (t.type === 'expense') spend += t.amount;
        else income += t.amount;
      });
      // wallet = 10000 + income - spend
      const wallet = 10000 + income - spend;

      spendEl.textContent = spend.toLocaleString('en-IN');
      incomeEl.textContent = income.toLocaleString('en-IN');
      walletEl.textContent = wallet.toLocaleString('en-IN');

      updateChart(spend, income);
    }

    function renderRecent() {
      recentList.innerHTML = '';
      if (transactions.length === 0) {
        recentList.innerHTML = '<div class="muted" style="padding:10px">No transactions yet ‚Äî press + to add one</div>';
        return;
      }
      const show = transactions.slice().reverse().slice(0, 6);
      show.forEach(tx => {
        const d = document.createElement('div'); d.className = 'tx';
        const dateStr = new Date(tx.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: '2-digit' });
        d.innerHTML = `<div class="avatar">${tx.type === 'expense' ? 'üí∏' : 'üí∞'}</div>
      <div class="meta">
        <div class="left">
          <div class="desc">${tx.categoryName || tx.category}</div>
          <div class="sub">${tx.note || ''}</div>
        </div>
        <div class="right">
          <div class="amt">${tx.type === 'expense' ? '-' : '+'} ‚Çπ${Number(tx.amount).toLocaleString('en-IN')}</div>
          <div class="date">${dateStr}</div>
        </div>
      </div>`;
        recentList.appendChild(d);
      });
    }

    function updateChart(spend, income) {
      const ctx = document.getElementById('pieChart').getContext('2d');
      if (pieChart) pieChart.destroy();
      pieChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Spending', 'Income'],
          datasets: [{ data: [spend, income], backgroundColor: ['#e67b88', '#79c78a'] }]
        },
        options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'bottom' } } }
      });
    }

    function openModal() { backdrop.style.display = 'flex'; buildCategoryGrid(); }
    function closeModal() { backdrop.style.display = 'none'; document.getElementById('amountInput').value = ''; document.getElementById('noteInput').value = ''; document.getElementById('dateInput').value = ''; }

    async function loadTransactions() {
      try {
        const res = await fetch(`https://expense-manager-bx5l.onrender.com/api/personal/${userEmail}`);
        if (res.ok) {
          transactions = await res.json();
          calculateTotals();
          renderRecent();
        }
      } catch (err) { console.error('Load Error:', err); }
    }

    async function saveTx() {
      const amt = Number(document.getElementById('amountInput').value);
      if (!amt || amt <= 0) { alert('Enter valid amount'); return; }
      const type = document.querySelector('input[name="ttype"]:checked').value;
      const note = document.getElementById('noteInput').value;
      const date = document.getElementById('dateInput').value || new Date().toISOString();
      const cat = categories.find(c => c.id === selectedCategory);

      const newTx = {
        userEmail: userEmail,
        type,
        amount: amt,
        category: selectedCategory,
        categoryName: cat.name,
        note,
        date
      };

      try {
        const res = await fetch('https://expense-manager-bx5l.onrender.com/api/personal/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newTx)
        });

        if (res.ok) {
          closeModal();
          loadTransactions(); // Reload from server
        } else {
          alert('Failed to save to server');
        }
      } catch (err) {
        console.error(err);
        alert('Network Error');
      }
    }

    document.getElementById('openModal').addEventListener('click', openModal);
    loadTransactions(); // Initial Load
  </script>

</body>

</html>